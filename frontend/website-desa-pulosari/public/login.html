<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Login Admin Desa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap");
      body {
        font-family: "Inter", sans-serif;
      }
      .bg-gradient-green {
        background: linear-gradient(
          135deg,
          #065f46 0%,
          #047857 50%,
          #059669 100%
        );
      }
      .glass-effect {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .input-glow:focus {
        box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
      }
      .floating-animation {
        animation: float 6s ease-in-out infinite;
      }
      @keyframes float {
        0%,
        100% {
          transform: translateY(0px);
        }
        50% {
          transform: translateY(-20px);
        }
      }
      .pulse-green {
        animation: pulse-green 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
      }
      @keyframes pulse-green {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.7;
        }
      }
    </style>
  </head>
  <body
    class="min-h-screen bg-gradient-green flex items-center justify-center p-4"
  >
    <!-- Background Decorations -->
    <div class="absolute inset-0 overflow-hidden">
      <div
        class="absolute -top-40 -right-40 w-80 h-80 bg-green-400 rounded-full opacity-20 floating-animation"
      ></div>
      <div
        class="absolute -bottom-40 -left-40 w-96 h-96 bg-emerald-400 rounded-full opacity-15 floating-animation"
        style="animation-delay: -3s"
      ></div>
      <div
        class="absolute top-1/3 left-1/4 w-32 h-32 bg-green-300 rounded-full opacity-10 floating-animation"
        style="animation-delay: -1s"
      ></div>
    </div>

    <!-- Login Container -->
    <div class="relative w-full max-w-md">
      <!-- Success Alert (Hidden by default) -->
      <div
        id="successAlert"
        class="hidden mb-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg"
      >
        <div class="flex items-center">
          <i class="fas fa-check-circle mr-2"></i>
          <span>Login berhasil! Mengalihkan...</span>
        </div>
      </div>

      <!-- Error Alert (Hidden by default) -->
      <div
        id="errorAlert"
        class="hidden mb-4 p-4 bg-red-100 border border-red-400 text-red-700 rounded-lg"
      >
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-2"></i>
          <span id="errorMessage">Username atau password salah!</span>
        </div>
      </div>

      <!-- Main Login Card -->
      <div
        class="glass-effect rounded-2xl shadow-2xl p-8 transform hover:scale-105 transition-all duration-300"
      >
        <!-- Logo and Title -->
        <div class="text-center mb-8">
          <div
            class="inline-block p-4 bg-white bg-opacity-20 rounded-full mb-4 pulse-green"
          >
            <i class="fas fa-building text-4xl text-white"></i>
          </div>
          <h1 class="text-2xl font-bold text-white mb-2">
            Sistem Informasi Desa
          </h1>
          <p class="text-green-100">Portal Admin Desa</p>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
          <!-- Username Field -->
          <div class="space-y-2">
            <label
              for="username"
              class="block text-sm font-medium text-green-100"
            >
              <i class="fas fa-user mr-2"></i>Username Admin
            </label>
            <div class="relative">
              <input
                type="text"
                id="username"
                name="username"
                required
                class="w-full px-4 py-3 bg-white bg-opacity-10 border border-green-300 border-opacity-30 rounded-lg text-white placeholder-green-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent input-glow transition-all duration-300"
                placeholder="Masukkan username admin"
              />
              <div class="absolute inset-y-0 right-0 pr-3 flex items-center">
                <i class="fas fa-user-shield text-green-300"></i>
              </div>
            </div>
          </div>

          <!-- Password Field -->
          <div class="space-y-2">
            <label
              for="password"
              class="block text-sm font-medium text-green-100"
            >
              <i class="fas fa-lock mr-2"></i>Password
            </label>
            <div class="relative">
              <input
                type="password"
                id="password"
                name="password"
                required
                class="w-full px-4 py-3 bg-white bg-opacity-10 border border-green-300 border-opacity-30 rounded-lg text-white placeholder-green-200 focus:outline-none focus:ring-2 focus:ring-green-400 focus:border-transparent input-glow transition-all duration-300"
                placeholder="Masukkan password"
              />
              <button
                type="button"
                id="togglePassword"
                class="absolute inset-y-0 right-0 pr-3 flex items-center text-green-300 hover:text-green-200 transition-colors duration-200"
              >
                <i id="eyeIcon" class="fas fa-eye"></i>
              </button>
            </div>
          </div>

          <!-- Remember Me -->
          <div class="flex items-center">
            <input
              type="checkbox"
              id="remember"
              class="w-4 h-4 text-green-600 bg-transparent border-green-300 rounded focus:ring-green-500 focus:ring-2"
            />
            <label for="remember" class="ml-2 text-sm text-green-100"
              >Ingat saya</label
            >
          </div>

          <!-- Login Button -->
          <button
            type="submit"
            id="loginBtn"
            class="w-full bg-gradient-to-r from-green-500 to-emerald-600 hover:from-green-600 hover:to-emerald-700 text-white font-semibold py-3 px-6 rounded-lg transition-all duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-50 shadow-lg"
          >
            <span id="loginText">
              <i class="fas fa-sign-in-alt mr-2"></i>Masuk sebagai Admin
            </span>
            <span id="loadingText" class="hidden">
              <i class="fas fa-spinner fa-spin mr-2"></i>Memproses...
            </span>
          </button>
        </form>

        <!-- Footer Info -->
        <div class="mt-8 text-center">
          <p class="text-xs text-green-200 opacity-80">
            <i class="fas fa-shield-alt mr-1"></i>
            Akses terbatas untuk administrator desa
          </p>
          <p class="text-xs text-green-200 opacity-60 mt-2">
            Â© 2025 Sistem Informasi Desa
          </p>
        </div>
      </div>

      <!-- Info Card for Regular Users -->
      <div class="mt-6 glass-effect rounded-xl p-4 text-center">
        <p class="text-green-100 text-sm">
          <i class="fas fa-info-circle mr-2"></i>
          Untuk warga desa, layanan dapat diakses tanpa login
        </p>
        <a
          href="/"
          target="_top"
          class="inline-block mt-2 text-green-300 hover:text-green-200 text-sm font-medium transition-colors duration-200"
        >
          Kembali ke Beranda <i class="fas fa-arrow-right ml-1"></i>
        </a>
      </div>
    </div>

    <script>
      // =================================================================
      // == CONFIGURATION: SET YOUR BACKEND API URL HERE              ==
      // =================================================================
      // For development, this should point to your local Hono server.
      // For production, this must be your deployed backend URL.
      const API_BASE_URL = "http://127.0.0.1:8787";

      // This should be your frontend's URL in production for security.
      const PARENT_WINDOW_ORIGIN = "*"; // e.g., 'https://your-frontend.pages.dev'
      // =================================================================

      // DOM Elements
      const loginForm = document.getElementById("loginForm");
      const usernameInput = document.getElementById("username");
      const passwordInput = document.getElementById("password");
      const togglePassword = document.getElementById("togglePassword");
      const eyeIcon = document.getElementById("eyeIcon");
      const loginBtn = document.getElementById("loginBtn");
      const loginText = document.getElementById("loginText");
      const loadingText = document.getElementById("loadingText");
      const successAlert = document.getElementById("successAlert");
      const errorAlert = document.getElementById("errorAlert");
      const errorMessage = document.getElementById("errorMessage");

      // Toggle Password Visibility
      togglePassword.addEventListener("click", function () {
        const type =
          passwordInput.getAttribute("type") === "password"
            ? "text"
            : "password";
        passwordInput.setAttribute("type", type);
        eyeIcon.className = `fas ${
          type === "password" ? "fa-eye" : "fa-eye-slash"
        }`;
      });

      // Alert Management
      function hideAlerts() {
        successAlert.classList.add("hidden");
        errorAlert.classList.add("hidden");
      }

      function showSuccess(message) {
        hideAlerts();
        successAlert.querySelector("span").textContent = message;
        successAlert.classList.remove("hidden");
      }

      function showError(message) {
        hideAlerts();
        errorMessage.textContent = message;
        errorAlert.classList.remove("hidden");
      }

      // Client-Side Form Validation
      function validateForm() {
        if (!usernameInput.value.trim() || !passwordInput.value.trim()) {
          showError("Username dan password tidak boleh kosong!");
          return false;
        }
        return true;
      }

      // Reset Button to its initial state
      function resetButton() {
        loginBtn.disabled = false;
        loginText.classList.remove("hidden");
        loadingText.classList.add("hidden");
      }

      // Asynchronous Login Process
      async function processLogin(username, password) {
        // 1. Show loading state on the button
        loginBtn.disabled = true;
        loginText.classList.add("hidden");
        loadingText.classList.remove("hidden");
        hideAlerts();

        try {
          // 2. Send credentials to the backend API
          const response = await fetch(`${API_BASE_URL}/api/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ username, password }),
            credentials: "include",
          });

          const result = await response.json();

          // 3. Handle the response from the backend
          if (result.success) {
            showSuccess("Login berhasil! Mengalihkan...");
            // 4. On success, notify the parent React app
            // The browser has stored the session cookie automatically.
            // The parent app will now verify the session via the /api/me endpoint.
            setTimeout(() => {
              window.parent.postMessage("loginSuccess", PARENT_WINDOW_ORIGIN);
            }, 1000); // Delay allows user to see the success message
          } else {
            // Show error message from the server and reset the button
            showError(
              result.message || "Terjadi kesalahan yang tidak diketahui."
            );
            resetButton();
          }
        } catch (error) {
          // Handle network or other unexpected errors
          console.error("Login request failed:", error);
          showError("Tidak dapat terhubung ke server. Coba lagi nanti.");
          resetButton();
        }
      }

      // Form Submit Handler
      loginForm.addEventListener("submit", async function (e) {
        e.preventDefault();
        if (!validateForm()) {
          return;
        }
        await processLogin(
          usernameInput.value.trim(),
          passwordInput.value.trim()
        );
      });

      // Hide alerts when user starts typing again
      usernameInput.addEventListener("input", hideAlerts);
      passwordInput.addEventListener("input", hideAlerts);
    </script>
  </body>
</html>
